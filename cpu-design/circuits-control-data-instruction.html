<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Unit for Data Instruction</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#1A1A1A',
                        accent: '#2563EB', // Royal Blue
                        bg: '#FDFBF8',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom focus styles for accessibility */
        *:focus-visible {
            outline: 3px solid #2563EB;
            outline-offset: 2px;
        }
        .tab-active {
            border-bottom: 3px solid #2563EB;
            color: #2563EB;
            font-weight: 600;
        }
        .tab-inactive {
            border-bottom: 3px solid transparent;
            color: #6B7280;
        }
        .tab-inactive:hover {
            color: #1A1A1A;
            border-bottom-color: #D1D5DB;
        }
    </style>
</head>
<body class="bg-[#FDFBF8] text-[#1A1A1A] font-sans antialiased min-h-screen flex flex-col">

    <!-- Skip to Content -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-accent text-white px-4 py-2 rounded shadow-lg z-50">
        Skip to Content
    </a>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <h1 class="text-3xl font-bold text-gray-900">Control Unit for Data Instruction</h1>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="flex-grow max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        
        <!-- Introduction -->
        <section class="prose prose-lg max-w-none mb-10 text-gray-800">
            <p>
                Before we begin, we first have to define how our Instruction Register works for Data Instructions.
                We will look at the breakdown of the instruction bits, the Control Unit diagram, the CPU diagram, and finally a video demonstration.
            </p>
        </section>

        <!-- Tabs Container -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <!-- Tab List -->
            <div class="border-b border-gray-200 overflow-x-auto">
                <nav class="flex -mb-px" aria-label="Tabs" role="tablist">
                    <button onclick="switchTab('tab1')" id="btn-tab1" role="tab" aria-selected="true" aria-controls="tab1" class="tab-active whitespace-nowrap py-4 px-6 text-sm font-medium transition-colors duration-200 focus:outline-none">
                        Data Instructions
                    </button>
                    <button onclick="switchTab('tab2')" id="btn-tab2" role="tab" aria-selected="false" aria-controls="tab2" class="tab-inactive whitespace-nowrap py-4 px-6 text-sm font-medium transition-colors duration-200 focus:outline-none">
                        Control Unit
                    </button>
                    <button onclick="switchTab('tab3')" id="btn-tab3" role="tab" aria-selected="false" aria-controls="tab3" class="tab-inactive whitespace-nowrap py-4 px-6 text-sm font-medium transition-colors duration-200 focus:outline-none">
                        CPU Diagram
                    </button>
                    <button onclick="switchTab('tab4')" id="btn-tab4" role="tab" aria-selected="false" aria-controls="tab4" class="tab-inactive whitespace-nowrap py-4 px-6 text-sm font-medium transition-colors duration-200 focus:outline-none">
                        Video
                    </button>
                </nav>
            </div>

            <!-- Tab 1: Data Instructions -->
            <div id="tab1" role="tabpanel" aria-labelledby="btn-tab1" class="p-6 sm:p-8 focus:outline-none" tabindex="0">
                <div class="prose max-w-none">
                    <h2>Data Instructions Breakdown</h2>
                    <p>The Data instruction is an 8-bit value broken down as follows:</p>
                    
                    <!-- Responsive Table Container -->
                    <div class="overflow-x-auto my-6 border rounded-lg">
                        <table class="min-w-[600px] w-full text-sm text-center">
                            <thead class="bg-gray-50 text-gray-700 uppercase">
                                <tr>
                                    <th class="px-4 py-3 border-b">Bit 0</th>
                                    <th class="px-4 py-3 border-b">Bit 1</th>
                                    <th class="px-4 py-3 border-b">Bit 2</th>
                                    <th class="px-4 py-3 border-b">Bit 3</th>
                                    <th class="px-4 py-3 border-b">Bit 4</th>
                                    <th class="px-4 py-3 border-b">Bit 5</th>
                                    <th class="px-4 py-3 border-b">Bit 6</th>
                                    <th class="px-4 py-3 border-b">Bit 7</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="divide-x divide-gray-200">
                                    <td class="px-4 py-3">0 (Data Instr)</td>
                                    <td class="px-4 py-3 bg-blue-50">Op Code</td>
                                    <td class="px-4 py-3 bg-blue-50">Op Code</td>
                                    <td class="px-4 py-3 bg-blue-50">Op Code</td>
                                    <td class="px-4 py-3 bg-green-50">Reg / Unused</td>
                                    <td class="px-4 py-3 bg-green-50">Reg / Unused</td>
                                    <td class="px-4 py-3 bg-orange-50">Reg / Val</td>
                                    <td class="px-4 py-3 bg-orange-50">Reg / Val</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h3>Bit Definitions</h3>
                    <ul class="list-disc pl-5 space-y-2">
                        <li><strong>Bit 0:</strong> When this is 0, we have a Data Instruction.</li>
                        <li><strong>Bits 1-3:</strong> The Operation code (based upon the table below).</li>
                        <li><strong>Bits 4-5:</strong> Define which Register (0-3) will be used. (Sometimes unused depending on Op Code).</li>
                        <li><strong>Bits 6-7:</strong> Define which Register (0-3) will be used OR an immediate value.</li>
                    </ul>

                    <h3>Data Operations Table</h3>
                    <div class="overflow-x-auto my-6 border rounded-lg max-w-md">
                        <table class="w-full text-sm text-center divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3">Operation</th>
                                    <th class="px-4 py-3">Bit 1</th>
                                    <th class="px-4 py-3">Bit 2</th>
                                    <th class="px-4 py-3">Bit 3</th>
                                    <th class="px-4 py-3 text-left">Description</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <tr><td class="px-4 py-2 font-medium">LOAD</td><td>0</td><td>0</td><td>0</td><td class="text-left text-xs text-gray-600">Load Register from RAM</td></tr>
                                <tr><td class="px-4 py-2 font-medium">STORE</td><td>0</td><td>0</td><td>1</td><td class="text-left text-xs text-gray-600">Store Register to RAM</td></tr>
                                <tr><td class="px-4 py-2 font-medium">DATA</td><td>0</td><td>1</td><td>0</td><td class="text-left text-xs text-gray-600">Load Immediate Value</td></tr>
                                <tr><td class="px-4 py-2 font-medium">JMPR</td><td>0</td><td>1</td><td>1</td><td class="text-left text-xs text-gray-600">Jump to Register Address</td></tr>
                                <tr><td class="px-4 py-2 font-medium">JMP</td><td>1</td><td>0</td><td>0</td><td class="text-left text-xs text-gray-600">Jump to Immediate Address</td></tr>
                                <tr><td class="px-4 py-2 font-medium">JEQ</td><td>1</td><td>0</td><td>1</td><td class="text-left text-xs text-gray-600">Jump if Equal</td></tr>
                                <tr><td class="px-4 py-2 font-medium">CLR</td><td>1</td><td>1</td><td>0</td><td class="text-left text-xs text-gray-600">Clear Register</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <h3>Register Codes</h3>
                    <div class="overflow-x-auto my-6 border rounded-lg max-w-sm">
                        <table class="w-full text-sm text-center divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3">Bit 4 / 6</th>
                                    <th class="px-4 py-3">Bit 5 / 7</th>
                                    <th class="px-4 py-3">Register</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <tr><td>0</td><td>0</td><td class="font-medium">R0</td></tr>
                                <tr><td>0</td><td>1</td><td class="font-medium">R1</td></tr>
                                <tr><td>1</td><td>0</td><td class="font-medium">R2</td></tr>
                                <tr><td>1</td><td>1</td><td class="font-medium">R3</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Control Unit Diagram -->
            <div id="tab2" role="tabpanel" aria-labelledby="btn-tab2" class="hidden p-6 sm:p-8 focus:outline-none" tabindex="0">
                <div class="prose max-w-none">
                    <h2>Data Instruction Control Unit Diagram</h2>
                    <p>The Control Unit logic for handling the various data instructions is detailed below.</p>
                    
                    <figure class="my-8">
                        <img src="images/control-unit-data-diagram.jpg" alt="Control Unit Diagram for Data Instruction" class="w-full h-auto rounded shadow-md border border-gray-200">
                        <figcaption class="text-sm text-gray-500 mt-2 text-center">Figure 1: Control Unit Circuit Diagram for Data Instructions</figcaption>
                    </figure>
                </div>
            </div>

            <!-- Tab 3: CPU Diagram -->
            <div id="tab3" role="tabpanel" aria-labelledby="btn-tab3" class="hidden p-6 sm:p-8 focus:outline-none" tabindex="0">
                <div class="prose max-w-none">
                    <h2>CPU for Data Instruction</h2>
                    <p>The temporary modifications included in this diagram for testing purposes include:</p>
                    <ul class="list-disc pl-5 space-y-2">
                        <li>Disconnection RAM Input from the BUS so you can manually set the value stored in RAM.</li>
                        <li>Fix <strong>RAM_S</strong> to 1 because we don't have all of the circuitry in this example.</li>
                        <li>Removing <strong>IR</strong> from the BUS so we can manually set the value (IR_S is 1).</li>
                        <li>Setting <strong>PC_S</strong> to 1 so that we have an initial value to start with.</li>
                    </ul>

                    <figure class="my-8">
                        <img src="images/cpu-data-layout.jpg" alt="CPU Diagram for Data Instruction" class="w-full h-auto rounded shadow-md border border-gray-200">
                        <figcaption class="text-sm text-gray-500 mt-2 text-center">Figure 2: CPU Layout Diagram</figcaption>
                    </figure>
                </div>
            </div>

            <!-- Tab 4: Video -->
            <div id="tab4" role="tabpanel" aria-labelledby="btn-tab4" class="hidden p-6 sm:p-8 focus:outline-none" tabindex="0">
                <div class="prose max-w-none">
                    <h2>Video Description of Operation</h2>
                    <p>The following video demonstrates the execution of data instructions within the circuit. Use the transcript panel to navigate the video or click any transcript line to jump to that moment.</p>
                    
                    <!-- Video and Transcript Container -->
                    <div class="flex flex-col lg:flex-row gap-4 w-full my-6">
                      <!-- Video Player Section: 66% width on large screens -->
                      <div class="w-full lg:w-2/3 flex-shrink-0">
                        <div id="video-container" style="width: 100%; height: 0; padding-bottom: 56.25%; position: relative;">
                          <iframe id="youtube-player"
                                  style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                                  src="https://www.youtube.com/embed/8Y-iYrDWodM?enablejsapi=1"
                                  title="Data Instruction: Detailed Walkthrough of Control Unit Operation"
                                  frameborder="0"
                                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                  referrerpolicy="strict-origin-when-cross-origin"
                                  allowfullscreen>
                          </iframe>
                        </div>
                      </div>

                      <!-- Transcript Container Section: 33% width on large screens -->
                      <div class="w-full lg:w-1/3 flex-shrink-0">
                        <div id="transcript-container" class="h-96 overflow-y-scroll bg-white shadow-inner p-4 rounded-lg border border-gray-300">
                          <p class="text-gray-500 text-center">Loading transcript...</p>
                        </div>
                      </div>
                    </div>

                    <!-- CSS for highlighting the active line -->
                    <style>
                      .active-transcript-line {
                        background-color: #f0f7ff;
                        font-weight: 600;
                        border-left: 4px solid #1e88e5;
                        padding-left: 12px;
                        transition: background-color 0.2s;
                      }
                    </style>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-auto">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <p class="text-center text-sm text-gray-500">
                &copy; 2025 Instructional Content. All rights reserved.
            </p>
        </div>
    </footer>

    <script>
        // ============== TAB SWITCHING LOGIC ==============
        function switchTab(tabId) {
            // Get all tabs and panels
            const tabs = document.querySelectorAll('[role="tab"]');
            const panels = document.querySelectorAll('[role="tabpanel"]');

            // Loop through tabs to update state
            tabs.forEach(tab => {
                const isSelected = tab.getAttribute('onclick').includes(tabId);
                tab.setAttribute('aria-selected', isSelected);
                
                if (isSelected) {
                    tab.classList.remove('tab-inactive');
                    tab.classList.add('tab-active');
                } else {
                    tab.classList.remove('tab-active');
                    tab.classList.add('tab-inactive');
                }
            });

            // Loop through panels to show/hide
            panels.forEach(panel => {
                if (panel.id === tabId) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });

            // Initialize transcript when video tab is opened
            if (tabId === 'tab4') {
                initializeVideoTranscript();
            }
        }

        // Handle keyboard navigation for tabs
        document.addEventListener('keydown', function(e) {
            const currentTab = document.activeElement;
            if (currentTab.getAttribute('role') !== 'tab') return;

            const tabs = Array.from(document.querySelectorAll('[role="tab"]'));
            const index = tabs.indexOf(currentTab);
            
            let nextIndex = null;

            if (e.key === 'ArrowRight') {
                nextIndex = (index + 1) % tabs.length;
            } else if (e.key === 'ArrowLeft') {
                nextIndex = (index - 1 + tabs.length) % tabs.length;
            }

            if (nextIndex !== null) {
                e.preventDefault();
                tabs[nextIndex].focus();
                tabs[nextIndex].click();
            }
        });

        // ============== YOUTUBE TRANSCRIPT SYNC LOGIC ==============
        const VIDEO_ID = '8Y-iYrDWodM';
        let player;
        let timeUpdater;
        let parsedTranscript = [];
        let videoInitialized = false;

        // --- RAW VTT CONTENT ---
        const vttContent = `WEBVTT

00:00.000 --> 00:12.600
Aloha in this video we're going to talk about the data instruction and so when we look at the

00:12.600 --> 00:22.800
data instruction okay we have our instruction our opcode and instruction register as zero zero one

00:22.800 --> 00:32.400
zero so zero zero one zero blank blank we don't care and then two for register B and what that's

00:32.400 --> 00:43.080
gonna do is it's gonna grab the data in the next RAM lot spot next byte of RAM and put it into

00:43.080 --> 00:51.060
register B what we define as register B all right so what we're gonna do so it's zero zero one zero

00:51.060 --> 00:52.780
and then register B

00:52.800 --> 01:01.140
so we want to do is we have it set up so that we can run our simulation and so zero zero one

01:01.140 --> 01:10.020
zero is our instruction register and then register B we want to put it into register three we can

01:10.020 --> 01:20.820
make it one one register three and then we need to have something put into RAM so I'm gonna go

01:20.820 --> 01:22.040
zero one one one

01:22.800 --> 01:32.560
zero zero one one zero okay so zero one one zero zero one one zero so we're going to stick that

01:32.560 --> 01:40.800
into ram and it's going to go into memory address zero okay so when we look at our control unit

01:42.000 --> 01:48.480
remember we're starting this with just the data instruction and we're not doing the fetch

01:48.480 --> 01:58.160
part which is steps one two and three so normally we would have fetched the address of our first um

02:00.720 --> 02:08.800
our first um instruction and that would be in byte zero and then we'd now be in byte one but

02:08.800 --> 02:13.840
because of the way we're doing it we're actually in byte zero which means that first instruction

02:13.840 --> 02:18.240
was really in like byte negative one if you will because it happened before this

02:19.200 --> 02:23.840
and that just happens because we're just trying to focus on just this one step of the process

02:25.040 --> 02:31.520
all right so anyway what we're going to do is we're going to cycle through this and the idea

02:31.520 --> 02:37.200
is we're going to grab it from zero and we're going to put it into register three

02:38.720 --> 02:43.280
okay so we're going to grab it from the next byte because our current instruction

02:45.200 --> 02:48.320
this instruction we stuck in here because it's in here it

02:48.480 --> 02:52.080
is going to be at zero and we're going to put it inside of our data

02:52.720 --> 02:57.680
and then we're going to put it in our data and now what's going to happen before this this is

02:57.680 --> 03:01.280
the next one the next one's at zero but the next one's not going to be at zero because

03:01.280 --> 03:05.280
zero is going to be data and so the next one's actually going to be at one because maybe one

03:05.280 --> 03:11.360
passed the data okay so let's cycle through until we get to

03:14.080 --> 03:17.280
cycle four i haven't enabled it yet but cycle four you're going to see that

03:17.280 --> 03:18.240
when we enable

03:18.240 --> 03:28.000
to set the program code enable memory address and the accumulator set memory address set and

03:28.000 --> 03:31.600
accumulator set so what's going to be on there is going to be zero because that's the current

03:31.600 --> 03:36.800
program code for the next one and it's going to be all zero so the memory address will be zero

03:37.440 --> 03:43.040
the accumulator set will be one because we have the bus one of one so it'll be one plus zero is one

03:43.040 --> 03:55.920
okay so we look at our data instruction and we cycle here we are on the enable it's all zeros

03:58.240 --> 04:05.120
okay our accumulator or our cpu is putting out one because b is one

04:06.400 --> 04:09.680
a is zero b is one so zero plus one is one

04:12.160 --> 04:12.400
um

04:13.200 --> 04:15.360
our memory address

04:17.680 --> 04:20.560
we've set it we should gonna set it to zero on the next step

04:21.840 --> 04:28.560
right now it's zero waiting for it but it's not set yet okay so our data instruction

04:29.280 --> 04:35.360
will set everything that we can set okay so we set the accumulator we set the memory address

04:37.440 --> 04:42.160
right memory address register and the accumulator set so accumulator should be one memory address

04:42.160 --> 04:44.980
Memory address should be, I mean, yeah, it should be one.

04:45.080 --> 04:46.180
Memory address should be zero.

04:48.860 --> 04:54.060
So if we go to memory address, it should be zero.

04:54.780 --> 04:56.060
It should be turned on.

04:56.660 --> 05:00.680
And it should hold 01100110 because that's the input that we put in.

05:01.540 --> 05:06.180
So that's in register zero, RAM byte zero.

05:06.180 --> 05:15.080
And our accumulator should be holding the value of one

05:15.080 --> 05:19.680
because bus one is one, one plus zero is one.

05:24.000 --> 05:28.180
All right, and then we'll cycle to the next step.

05:29.100 --> 05:31.520
We'll turn them off, turn off set, turn off enable,

05:31.520 --> 05:35.800
and then we'll cycle to the next one, which is step five.

05:36.340 --> 05:39.980
Step five now is going to enable RAM.

05:40.120 --> 05:44.200
So it's going to grab what's in byte zero and stick it on the bus.

05:44.540 --> 05:51.240
And then when we set, we're going to set our reg B to be the value that's on the bus.

05:52.180 --> 05:57.100
And in this case, reg B, it's going to be reg R3.

05:58.920 --> 06:03.060
Okay, so we'll go back to our data instruction.

06:03.520 --> 06:04.540
We click on set.

06:06.180 --> 06:08.220
Okay, so we set.

06:12.400 --> 06:15.200
And reg B, R3 is set here for reg B.

06:17.040 --> 06:19.640
So when we go back to now our data instruction,

06:19.860 --> 06:25.100
we'll see reg B holds 01100110, which is what we had in input.

06:26.440 --> 06:28.820
Okay, and then we'll cycle again.

06:32.420 --> 06:34.240
Where our last one is six.

06:35.000 --> 06:36.160
And that's going to enable RAM.

06:36.180 --> 06:41.400
And then we're going to enable the accumulator and set the program code for the next instruction.

06:42.500 --> 06:44.620
Okay, and so that should be one.

06:46.200 --> 06:48.900
Because we just used zero for data.

06:50.400 --> 07:00.580
So zero can't be the next instruction because byte zero was data.

07:01.680 --> 07:04.300
So the next instruction will be in byte one.

07:04.300 --> 07:04.640
Okay.

07:06.180 --> 07:07.200
And we enabled it.

07:07.300 --> 07:08.080
We set it.

07:09.340 --> 07:10.540
Here we set it.

07:11.020 --> 07:12.220
So PC code is one.

07:14.080 --> 07:14.600
Okay.

07:15.940 --> 07:19.420
And then we'll click off set.

07:19.500 --> 07:20.020
Click off enable.

07:20.260 --> 07:22.160
And that's the cycle of data instruction.

07:22.880 --> 07:28.360
So it's grabbing what's in the next byte of RAM and sticking it into one of the regs.

07:28.360 --> 07:28.800
Okay.`;

        // 2. CORE UTILITIES
        function timeToSeconds(timeStr) {
            if (!timeStr) return 0;
            const parts = timeStr.trim().split(':');
            
            // Handle both MM:SS.mmm and HH:MM:SS.mmm formats
            if (parts.length === 2) {
                // MM:SS.mmm format
                let minutes = parseInt(parts[0]) || 0;
                let seconds = parseFloat(parts[1]) || 0;
                return minutes * 60 + seconds;
            } else if (parts.length === 3) {
                // HH:MM:SS.mmm format
                let hours = parseInt(parts[0]) || 0;
                let minutes = parseInt(parts[1]) || 0;
                let seconds = parseFloat(parts[2]) || 0;
                return hours * 3600 + minutes * 60 + seconds;
            }
            return 0;
        }

        function parseVtt(vttText) {
            const cues = vttText.trim().split(/\n\n+/);
            const parsedCues = [];
            
            cues.forEach(cueBlock => {
                if (cueBlock.startsWith('WEBVTT') || cueBlock.trim() === '') return;
                
                const lines = cueBlock.trim().split('\n');
                const timeLine = lines.find(line => line.includes('-->'));
                if (!timeLine) return;

                const [startTimeStr, endTimeStr] = timeLine.split(' --> ');
                const textLines = lines.slice(lines.indexOf(timeLine) + 1);
                
                parsedCues.push({
                    start: timeToSeconds(startTimeStr),
                    end: timeToSeconds(endTimeStr),
                    text: textLines.join(' ').trim()
                });
            });
            return parsedCues;
        }

        // 3. TRANSCRIPT RENDERING AND INTERACTIVITY
        function populateTranscript() {
            const container = document.getElementById('transcript-container');
            if (!container) return;
            container.innerHTML = '';

            parsedTranscript.forEach(cue => {
                const lineElement = document.createElement('div');
                lineElement.className = 'transcript-line p-2 cursor-pointer hover:bg-gray-100 rounded-lg';
                lineElement.dataset.start = cue.start;
                lineElement.dataset.end = cue.end;
                lineElement.textContent = cue.text;
                lineElement.setAttribute('role', 'button');
                lineElement.setAttribute('tabindex', '0');

                const seekToTime = () => {
                    if (player && player.seekTo) {
                        player.seekTo(cue.start, true);
                        player.playVideo();
                    }
                };
                
                lineElement.addEventListener('click', seekToTime);
                lineElement.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') { 
                        e.preventDefault(); 
                        seekToTime(); 
                    }
                });

                container.appendChild(lineElement);
            });
        }

        // 4. SYNC LOGIC
        function highlightCurrentLine() {
            if (!player || !player.getCurrentTime) return;

            const currentTime = player.getCurrentTime();
            const lines = document.querySelectorAll('#transcript-container .transcript-line');

            lines.forEach(line => {
                const start = parseFloat(line.dataset.start);
                const end = parseFloat(line.dataset.end);

                if (currentTime >= start && currentTime < end) {
                    if (!line.classList.contains('active-transcript-line')) {
                        document.querySelector('.active-transcript-line')?.classList.remove('active-transcript-line');
                        line.classList.add('active-transcript-line');
                        line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                } else {
                    line.classList.remove('active-transcript-line');
                }
            });
        }

        // 5. HEIGHT SYNCHRONIZATION (Transcript matches video container)
        function syncTranscriptHeight() {
            const mediaQuery = window.matchMedia('(min-width: 1024px)');
            const videoContainer = document.getElementById('video-container');
            const transcriptContainer = document.getElementById('transcript-container');
            
            if (!videoContainer || !transcriptContainer) return;
            
            if (mediaQuery.matches) {
                // On large screens, match the video container height
                const videoHeight = videoContainer.offsetHeight;
                transcriptContainer.style.maxHeight = videoHeight + 'px';
            } else {
                // On mobile, use fixed height
                transcriptContainer.style.maxHeight = '24rem';
            }
        }

        // 6. PLAYER STATE HANDLER
        function onPlayerStateChange(event) {
            clearInterval(timeUpdater);
            if (event.data === YT.PlayerState.PLAYING) {
                timeUpdater = setInterval(highlightCurrentLine, 300);
            }
        }

        // 7. INITIALIZATION
        function initializeVideoTranscript() {
            if (videoInitialized) return;
            videoInitialized = true;

            parsedTranscript = parseVtt(vttContent);
            populateTranscript();
            syncTranscriptHeight();

            if (!player) {
                player = new YT.Player('youtube-player', {
                    events: {
                        'onStateChange': onPlayerStateChange
                    }
                });
            }
        }

        // 8. CENTRAL INITIALIZATION
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof(YT) == 'undefined' || typeof(YT.Player) == 'undefined') {
                const tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                document.head.appendChild(tag);
                window.onYouTubeIframeAPIReady = initializeVideoTranscript;
            }

            // Handle window resize for transcript height sync
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(syncTranscriptHeight, 250);
            });
        });
    </script>
</body>
</html>
