<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arithmetic Circuits - CSC210</title>
    <link rel="stylesheet" href="shared/module-styles.css">
</head>
<body>
    <!-- Skip link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Module content structure -->
    <main class="module-container" id="main-content">
        <header class="section-header">
            <h1>Arithmetic Circuits</h1>
            <div class="progress-container">
                <div class="progress-text">
                    <span>Progress</span>
                    <span id="progress-text">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="module-progress"></div>
                </div>
            </div>
        </header>
        
        <!-- Section 1: Half-Adder -->
        <section class="section" id="half-adder-section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Half-Adder Circuit</h2>
                </div>
                
                <p>A half-adder is a fundamental digital circuit that performs addition of two single binary digits. It produces two outputs: a Sum and a Carry. The Sum output represents the result of addition (A ⊕ B), while the Carry output represents any overflow (A • B).</p>
                
                <div class="simulator-container">
                    <h3 class="text-center">Interactive Half-Adder Simulator</h3>
                    
                    <div class="simulator-controls">
                        <div class="control-group">
                            <h4>Inputs</h4>
                            <div class="checkbox-group">
                                <input type="checkbox" id="ha-input-a" class="checkbox" aria-label="Half-adder input A">
                                <label for="ha-input-a" class="checkbox-label">Input A</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="ha-input-b" class="checkbox" aria-label="Half-adder input B">
                                <label for="ha-input-b" class="checkbox-label">Input B</label>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <h4>Circuit Diagram</h4>
                            <canvas id="ha-circuit" class="circuit-canvas" width="400" height="200" 
                                    data-circuit-simulator="true" aria-label="Half-adder circuit diagram">
                            </canvas>
                        </div>
                        
                        <div class="control-group">
                            <h4>Outputs</h4>
                            <div class="output-display">
                                <div>Sum: <span class="output-value" id="ha-sum">0</span></div>
                                <div>Carry: <span class="output-value" id="ha-carry">0</span></div>
                            </div>
                            <p><strong>Sum = A ⊕ B</strong></p>
                            <p><strong>Carry = A • B</strong></p>
                        </div>
                    </div>
                    
                    <div class="truth-table-container">
                        <h4>Truth Table</h4>
                        <table class="truth-table" id="ha-truth-table" aria-label="Half-adder truth table">
                            <thead>
                                <tr><th>A</th><th>B</th><th>Sum</th><th>Carry</th></tr>
                            </thead>
                            <tbody>
                                <tr data-inputs="0,0"><td>0</td><td>0</td><td>0</td><td>0</td></tr>
                                <tr data-inputs="0,1"><td>0</td><td>1</td><td>1</td><td>0</td></tr>
                                <tr data-inputs="1,0"><td>1</td><td>0</td><td>1</td><td>0</td></tr>
                                <tr data-inputs="1,1"><td>1</td><td>1</td><td>0</td><td>1</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Section 2: Full-Adder -->
        <section class="section" id="full-adder-section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Full-Adder Circuit</h2>
                </div>
                
                <p>A full-adder extends the half-adder by accepting three inputs: two operands (A, B) and a carry-in (Cin) from a previous stage. This allows for cascading multiple adders to perform multi-bit addition. The outputs are Sum = A ⊕ B ⊕ Cin and Carry-out = AB + Cin(A ⊕ B).</p>
                
                <div class="simulator-container">
                    <h3 class="text-center">Interactive Full-Adder Simulator</h3>
                    
                    <div class="simulator-controls">
                        <div class="control-group">
                            <h4>Inputs</h4>
                            <div class="checkbox-group">
                                <input type="checkbox" id="fa-input-a" class="checkbox" aria-label="Full-adder input A">
                                <label for="fa-input-a" class="checkbox-label">Input A</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="fa-input-b" class="checkbox" aria-label="Full-adder input B">
                                <label for="fa-input-b" class="checkbox-label">Input B</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="fa-input-cin" class="checkbox" aria-label="Full-adder carry in">
                                <label for="fa-input-cin" class="checkbox-label">Carry In</label>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <h4>Circuit Diagram</h4>
                            <canvas id="fa-circuit" class="circuit-canvas" width="500" height="300" 
                                    data-circuit-simulator="true" aria-label="Full-adder circuit diagram">
                            </canvas>
                        </div>
                        
                        <div class="control-group">
                            <h4>Outputs</h4>
                            <div class="output-display">
                                <div>Sum: <span class="output-value" id="fa-sum">0</span></div>
                                <div>Carry Out: <span class="output-value" id="fa-carry">0</span></div>
                            </div>
                            <p><strong>Sum = A ⊕ B ⊕ Cin</strong></p>
                            <p><strong>Cout = AB + Cin(A ⊕ B)</strong></p>
                        </div>
                    </div>
                    
                    <div class="truth-table-container">
                        <h4>Truth Table</h4>
                        <table class="truth-table" id="fa-truth-table" aria-label="Full-adder truth table">
                            <thead>
                                <tr><th>A</th><th>B</th><th>Cin</th><th>Sum</th><th>Cout</th></tr>
                            </thead>
                            <tbody>
                                <tr data-inputs="0,0,0"><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
                                <tr data-inputs="0,0,1"><td>0</td><td>0</td><td>1</td><td>1</td><td>0</td></tr>
                                <tr data-inputs="0,1,0"><td>0</td><td>1</td><td>0</td><td>1</td><td>0</td></tr>
                                <tr data-inputs="0,1,1"><td>0</td><td>1</td><td>1</td><td>0</td><td>1</td></tr>
                                <tr data-inputs="1,0,0"><td>1</td><td>0</td><td>0</td><td>1</td><td>0</td></tr>
                                <tr data-inputs="1,0,1"><td>1</td><td>0</td><td>1</td><td>0</td><td>1</td></tr>
                                <tr data-inputs="1,1,0"><td>1</td><td>1</td><td>0</td><td>0</td><td>1</td></tr>
                                <tr data-inputs="1,1,1"><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Section 3: 4-Bit Ripple-Carry Adder -->
        <section class="section" id="ripple-carry-section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">4-Bit Ripple-Carry Adder</h2>
                </div>
                
                <p>A 4-bit ripple-carry adder chains four full-adders together to perform addition of two 4-bit binary numbers. The carry output from each stage "ripples" to the carry input of the next stage, creating a cascaded addition process. While simple to understand, the ripple-carry design has timing limitations due to carry propagation delays.</p>
                
                <div class="simulator-container">
                    <h3 class="text-center">Interactive 4-Bit Ripple-Carry Adder Simulator</h3>
                    
                    <div class="simulator-controls">
                        <div class="control-group">
                            <h4>4-bit Input A</h4>
                            <div class="checkbox-group">
                                <input type="checkbox" id="rc-a3" class="checkbox">
                                <label for="rc-a3" class="checkbox-label">A₃ (MSB)</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="rc-a2" class="checkbox">
                                <label for="rc-a2" class="checkbox-label">A₂</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="rc-a1" class="checkbox">
                                <label for="rc-a1" class="checkbox-label">A₁</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="rc-a0" class="checkbox">
                                <label for="rc-a0" class="checkbox-label">A₀ (LSB)</label>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <h4>4-bit Input B</h4>
                            <div class="checkbox-group">
                                <input type="checkbox" id="rc-b3" class="checkbox">
                                <label for="rc-b3" class="checkbox-label">B₃ (MSB)</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="rc-b2" class="checkbox">
                                <label for="rc-b2" class="checkbox-label">B₂</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="rc-b1" class="checkbox">
                                <label for="rc-b1" class="checkbox-label">B₁</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="rc-b0" class="checkbox">
                                <label for="rc-b0" class="checkbox-label">B₀ (LSB)</label>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <h4>Results & Control</h4>
                            <div class="checkbox-group">
                                <input type="checkbox" id="rc-carry-in" class="checkbox">
                                <label for="rc-carry-in" class="checkbox-label">Carry In</label>
                            </div>
                            <div class="output-display">
                                <div>Binary: <span class="output-value" id="rc-sum-binary">0000</span></div>
                                <div>Decimal: <span class="output-value" id="rc-sum-decimal">0</span></div>
                                <div>Carry Out: <span class="output-value" id="rc-carry-out">0</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <h4>Timing Analysis</h4>
                        <p>Critical Path: <span id="critical-path">4 gate delays</span></p>
                        <p>Propagation Pattern: C₀ → C₁ → C₂ → C₃ → Cout</p>
                        <p><small>Each full-adder adds 1 gate delay to the carry chain.</small></p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Section 4: Knowledge Assessment Quiz -->
        <section class="section" id="assessment-section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Knowledge Assessment</h2>
                </div>
                
                <p>Test your understanding of arithmetic circuits with this interactive quiz. You need to answer 6 out of 7 questions correctly to pass.</p>
                
                <div id="quiz-container" class="quiz-container">
                    <!-- Quiz will be populated by JavaScript -->
                </div>
            </div>
        </section>
    </main>

    <!-- Import shared JavaScript modules -->
    <script src="shared/module-utils.js"></script>
    <script src="shared/circuit-simulator.js"></script>
    
    <script>
        /* SET MODULE ID FIRST - CRITICAL FOR PLATFORM COMMUNICATION */
        window.MODULE_ID = 'arithmetic';
        
        /* ===== MODULE-SPECIFIC IMPLEMENTATIONS ===== */
        
        // Half-Adder Simulator
        class HalfAdderSimulator {
            constructor() {
                this.inputA = document.getElementById('ha-input-a');
                this.inputB = document.getElementById('ha-input-b');
                this.setupEventListeners();
                this.setupCircuit();
                this.calculate();
            }
            
            setupEventListeners() {
                this.inputA.addEventListener('change', () => this.calculate());
                this.inputB.addEventListener('change', () => this.calculate());
            }
            
            setupCircuit() {
                try {
                    this.circuitSim = new CircuitSimulator.CircuitSimulator('ha-circuit');
                    this.circuit = CircuitSimulator.CircuitTemplates.halfAdderCircuit(this.circuitSim);
                } catch (error) {
                    console.warn('Circuit visualization not available:', error);
                }
            }
            
            calculate() {
                const a = this.inputA.checked;
                const b = this.inputB.checked;
                
                const sum = a !== b; // XOR
                const carry = a && b; // AND
                
                this.updateDisplay(sum, carry);
                this.highlightTruthTableRow(a, b);
                this.updateCircuit(a, b);
            }
            
            updateDisplay(sum, carry) {
                document.getElementById('ha-sum').textContent = sum ? '1' : '0';
                document.getElementById('ha-carry').textContent = carry ? '1' : '0';
            }
            
            updateCircuit(a, b) {
                if (this.circuit && this.circuit.inputs) {
                    this.circuit.inputs.A.value = a;
                    this.circuit.inputs.B.value = b;
                    this.circuitSim.simulate();
                    this.circuitSim.render();
                }
            }
            
            highlightTruthTableRow(a, b) {
                const table = document.getElementById('ha-truth-table');
                const rows = table.querySelectorAll('tbody tr');
                
                rows.forEach(row => row.classList.remove('active-row'));
                
                const inputPattern = `${a ? 1 : 0},${b ? 1 : 0}`;
                const matchingRow = Array.from(rows).find(row => 
                    row.dataset.inputs === inputPattern
                );
                
                if (matchingRow) {
                    matchingRow.classList.add('active-row');
                }
            }
        }
        
        // Full-Adder Simulator
        class FullAdderSimulator {
            constructor() {
                this.inputA = document.getElementById('fa-input-a');
                this.inputB = document.getElementById('fa-input-b');
                this.inputCin = document.getElementById('fa-input-cin');
                this.setupEventListeners();
                this.calculate();
            }
            
            setupEventListeners() {
                this.inputA.addEventListener('change', () => this.calculate());
                this.inputB.addEventListener('change', () => this.calculate());
                this.inputCin.addEventListener('change', () => this.calculate());
            }
            
            calculate() {
                const a = this.inputA.checked;
                const b = this.inputB.checked;
                const cin = this.inputCin.checked;
                
                const sum = a !== b !== cin;
                const cout = (a && b) || (cin && (a !== b));
                
                this.updateDisplay(sum, cout);
                this.highlightTruthTableRow(a, b, cin);
            }
            
            updateDisplay(sum, cout) {
                document.getElementById('fa-sum').textContent = sum ? '1' : '0';
                document.getElementById('fa-carry').textContent = cout ? '1' : '0';
            }
            
            highlightTruthTableRow(a, b, cin) {
                const table = document.getElementById('fa-truth-table');
                const rows = table.querySelectorAll('tbody tr');
                
                rows.forEach(row => row.classList.remove('active-row'));
                
                const inputPattern = `${a ? 1 : 0},${b ? 1 : 0},${cin ? 1 : 0}`;
                const matchingRow = Array.from(rows).find(row => 
                    row.dataset.inputs === inputPattern
                );
                
                if (matchingRow) {
                    matchingRow.classList.add('active-row');
                }
            }
        }
        
        // 4-Bit Ripple-Carry Adder Simulator
        class RippleCarryAdderSimulator {
            constructor() {
                this.inputsA = [
                    document.getElementById('rc-a0'),
                    document.getElementById('rc-a1'),
                    document.getElementById('rc-a2'),
                    document.getElementById('rc-a3')
                ];
                this.inputsB = [
                    document.getElementById('rc-b0'),
                    document.getElementById('rc-b1'),
                    document.getElementById('rc-b2'),
                    document.getElementById('rc-b3')
                ];
                this.carryIn = document.getElementById('rc-carry-in');
                this.setupEventListeners();
                this.calculate();
            }
            
            setupEventListeners() {
                [...this.inputsA, ...this.inputsB, this.carryIn].forEach(input => {
                    input.addEventListener('change', () => this.calculate());
                });
            }
            
            calculate() {
                const aValues = this.inputsA.map(input => input.checked);
                const bValues = this.inputsB.map(input => input.checked);
                let carryIn = this.carryIn.checked;
                
                const sums = [];
                let carryOut = carryIn;
                
                // Calculate each bit position
                for (let i = 0; i < 4; i++) {
                    const a = aValues[i];
                    const b = bValues[i];
                    
                    const sum = a !== b !== carryOut;
                    const newCarryOut = (a && b) || (carryOut && (a !== b));
                    
                    sums[i] = sum;
                    carryOut = newCarryOut;
                }
                
                this.updateDisplay(sums, carryOut);
            }
            
            updateDisplay(sums, carryOut) {
                // Convert to binary string (MSB first for display)
                const binaryResult = [sums[3], sums[2], sums[1], sums[0]].map(s => s ? '1' : '0').join('');
                document.getElementById('rc-sum-binary').textContent = binaryResult;
                
                // Convert to decimal
                const decimalResult = parseInt(binaryResult, 2);
                document.getElementById('rc-sum-decimal').textContent = decimalResult.toString();
                
                document.getElementById('rc-carry-out').textContent = carryOut ? '1' : '0';
            }
        }

        // Quiz Data
        const quizData = [
            {
                question: "What are the outputs when A=1 and B=1 in a half-adder?",
                options: [
                    "Sum=0, Carry=1",
                    "Sum=1, Carry=0", 
                    "Sum=1, Carry=1",
                    "Sum=0, Carry=0"
                ],
                correct: 0,
                explanation: "In a half-adder, when both inputs are 1: Sum = A ⊕ B = 1 ⊕ 1 = 0, and Carry = A • B = 1 • 1 = 1"
            },
            {
                question: "What is the Boolean expression for the Sum output of a full-adder?",
                options: [
                    "A • B • Cin",
                    "A + B + Cin",
                    "A ⊕ B ⊕ Cin",
                    "A • B + Cin"
                ],
                correct: 2,
                explanation: "The Sum output of a full-adder uses XOR operations: Sum = A ⊕ B ⊕ Cin"
            },
            {
                question: "In a 4-bit ripple-carry adder, how many gate delays are in the critical path?",
                options: [
                    "2 gate delays",
                    "4 gate delays",
                    "6 gate delays",
                    "8 gate delays"
                ],
                correct: 1,
                explanation: "The critical path goes through all 4 carry stages, with each full-adder contributing 1 gate delay to the carry chain."
            },
            {
                question: "What is the main limitation of ripple-carry adders?",
                options: [
                    "They consume too much power",
                    "They are too complex to build",
                    "Carry propagation causes timing delays",
                    "They can only add positive numbers"
                ],
                correct: 2,
                explanation: "Ripple-carry adders have timing limitations because each carry must propagate through all stages before the final result is valid."
            },
            {
                question: "If A=1011 and B=0110 are added in a 4-bit adder with Cin=1, what is the result?",
                options: [
                    "10010 (binary), 18 (decimal)",
                    "10001 (binary), 17 (decimal)",
                    "01111 (binary), 15 (decimal)",
                    "10000 (binary), 16 (decimal)"
                ],
                correct: 0,
                explanation: "1011 + 0110 + 1 = 10010 in binary. Converting: 11 + 6 + 1 = 18 in decimal."
            },
            {
                question: "Which gate type is used for the Sum output in a half-adder?",
                options: [
                    "AND gate",
                    "OR gate", 
                    "XOR gate",
                    "NAND gate"
                ],
                correct: 2,
                explanation: "The Sum output uses an XOR gate because Sum = A ⊕ B, which produces 1 only when inputs differ."
            },
            {
                question: "How many full-adders are needed to build a 4-bit ripple-carry adder?",
                options: [
                    "3 full-adders",
                    "4 full-adders",
                    "5 full-adders",
                    "8 full-adders"
                ],
                correct: 1,
                explanation: "A 4-bit ripple-carry adder requires exactly 4 full-adders, one for each bit position."
            }
        ];

        // Module initialization
        let progressTracker;
        let halfAdder;
        let fullAdder; 
        let rippleCarryAdder;
        let quizManager;

        function initializeModule() {
            try {
                // Initialize progress tracking
                progressTracker = new ModuleUtils.ProgressTracker(window.MODULE_ID, [
                    'half-adder',
                    'full-adder', 
                    'ripple-carry',
                    'assessment'
                ]);
                window.progressTracker = progressTracker;

                // Initialize simulators
                halfAdder = new HalfAdderSimulator();
                fullAdder = new FullAdderSimulator();
                rippleCarryAdder = new RippleCarryAdderSimulator();
                
                // Initialize quiz
                quizManager = new ModuleUtils.QuizManager(quizData, 86); // Need 6/7 correct
                window.quizManager = quizManager;
                
                // Set up progress tracking
                setupProgressTracking();
                progressTracker.updateSectionProgress(0, 10);
                
                console.log('Arithmetic Circuits module initialized successfully');
                
            } catch (error) {
                console.error('Error initializing module:', error);
                showErrorMessage('Module failed to initialize. Please refresh the page.');
            }
        }

        function setupProgressTracking() {
            // Track half-adder interactions
            const haInputs = [
                document.getElementById('ha-input-a'),
                document.getElementById('ha-input-b')
            ];
            
            let haInteractions = 0;
            haInputs.forEach(input => {
                input.addEventListener('change', () => {
                    haInteractions++;
                    if (haInteractions >= 3) {
                        progressTracker.updateSectionProgress(0, 60);
                    }
                    if (haInteractions >= 6) {
                        progressTracker.completeSection(0);
                    }
                });
            });
            
            // Track full-adder interactions
            const faInputs = [
                document.getElementById('fa-input-a'),
                document.getElementById('fa-input-b'),
                document.getElementById('fa-input-cin')
            ];
            
            let faInteractions = 0;
            faInputs.forEach(input => {
                input.addEventListener('change', () => {
                    faInteractions++;
                    if (faInteractions >= 4) {
                        progressTracker.updateSectionProgress(1, 60);
                    }
                    if (faInteractions >= 8) {
                        progressTracker.completeSection(1);
                    }
                });
            });
            
            // Track ripple-carry interactions
            const rcInputs = [
                ...document.querySelectorAll('[id^="rc-a"]'),
                ...document.querySelectorAll('[id^="rc-b"]'),
                document.getElementById('rc-carry-in')
            ];
            
            let rcInteractions = 0;
            rcInputs.forEach(input => {
                input.addEventListener('change', () => {
                    rcInteractions++;
                    if (rcInteractions >= 5) {
                        progressTracker.updateSectionProgress(2, 60);
                    }
                    if (rcInteractions >= 10) {
                        progressTracker.completeSection(2);
                    }
                });
            });
        }

        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'card';
            errorDiv.style.backgroundColor = '#fee2e2';
            errorDiv.style.borderColor = '#dc2626';
            errorDiv.innerHTML = `
                <h3 style="color: #dc2626;">⚠ Error</h3>
                <p>${message}</p>
            `;
            
            document.querySelector('.module-container').insertBefore(
                errorDiv, 
                document.querySelector('.section')
            );
        }

        // Initialize when DOM loads
        document.addEventListener('DOMContentLoaded', initializeModule);

        // Handle page unload for cleanup
        window.addEventListener('beforeunload', () => {
            if (progressTracker && progressTracker.getTotalProgress() === 100) {
                progressTracker.markComplete();
            }
        });
    </script>
</body>
</html>
